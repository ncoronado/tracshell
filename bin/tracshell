#!/usr/bin/env python

import os
import sys
from optparse import OptionParser

from tracshell import settings
from tracshell import shell

def run():
    """
    This function starts the main program.
    """
    p = OptionParser(version="TracShell: %f" % shell.VERSION)
    p.add_option("--site", "-s", dest="site",
                 action="store", type="string",
                 default=None, help="Optional site to connect to")
    p.add_option("--file", "-f", dest="file",
                 action="store", type="string",
                 default=".tracshell", help="Specify the name of your settings file")
    opts, args = p.parse_args()

    s = settings.Settings(filename=opts.file)
    if opts.site:
        setattr(s, 'site', s.sites[opts.site])
    else:
        try:
            setattr(s, 'site', s.sites[s.default_site])
        except AttributeError:
            raise settings.ConfigError, "No default site specified"
        except KeyError:
            raise settings.ConfigError, "No default site specified"
    if hasattr(s, 'editor'):
        shell.start_shell(s)
    else:
        try:
            s.editor = os.environ['EDITOR']
        except KeyError:
            print >> sys.stderr, "Please specify an editor in your settings"
            print >> sys.stderr, "or set your EDITOR environment variable."
        else:
            shell.start_shell(s)

if __name__ == '__main__':
    run()
